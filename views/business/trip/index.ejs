<%# 공통 부분 %>
<%- include('../../layout/common.ejs') %>

<%# CSS & JS %>
<link href="/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
<link href="/stylesheets/datatable.css" rel="stylesheet" />
<link href="/stylesheets/trip.css" rel="stylesheet" />

<%# JS %>
<script src="/js/dataTables.min.js"></script>
<script src="/js/dataTables.bootstrap5.min.js"></script>
<script src="/js/dataTables.select.js"></script>
<script src="/js/select.dataTables.js"></script>
<script src="/javascripts/datatableOption.js"></script>

<%# 본문 %>
<%- contentFor('body') %>

<%# DataTable CheckBox Visible %>
<input type="hidden" id="chkVisible" value='N'>

<%# 메뉴명 & 버튼 %>
<div class="d-flex">
  <div class="ps-1">
    <h2>모두의 출장</h2>
  </div>
  <div class="d-flex ms-auto">
    <div>
      <button type="button" id="btnCreate" class="btn btn-primary" onclick="createItem()">등록</button>      
    </div>
    <div class="ms-1 visually-hidden">
      <button type="button" id="btnDelete" class="btn btn-danger" onclick="deleteItemList(event)">삭제</button>
    </div>
    <div class="ms-1">
      <button type="button" class="btn btn-warning" onclick="editItem(this)">편집</button>      
    </div>    
  </div>
</div>

<%# 그리드 %>
<table id="tblMain" class="table table-striped">
</table>

<%# 출장 추가 %>
<div class="modal fade" id="modalTripAdd" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
  aria-labelledby="lblModalFindPassword" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <!-- LoadingBar Modal of modalTripAdd -->
      <%- include('../../ejs/loadingbar.ejs') %>

        <!-- Modal Header -->
        <div class="modal-header">
          <h5 class="modal-title" id="lblModalTripAdd">출장 추가</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          <div class="img-outer">
            <img src="/images/logo_trip_add.png" onerror=this.src="/images/no_image.png">
          </div>
          <div class="mt-3 text-white rounded desp-outer">
            <h4>모두의 출장</h1> 
            <p>출장 생성 후 7일간 사용할 수 있습니다.</p>
            <p>단 모바일 앱에서 더보기 > 광고보기를 하면 7일의 기간을 갱신할 수 있습니다.</p>
          </div>
        </div>

        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-warning" data-bs-target="#modalImportTrip" data-bs-toggle="modal" data-bs-dismiss="modal">엑셀 불러오기</button>
          <button type="button" class="btn btn-primary" data-bs-target="#modalTermsOfService" data-bs-toggle="modal" data-bs-dismiss="modal" disabled>출장 만들기</button>
        </div>

    </div>
  </div>
</div>

<%# 출장 엑셀 등록 %>
<div class="modal fade" id="modalImportTrip" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
  aria-labelledby="lblModalFindPassword" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <!-- LoadingBar Modal of modalImportTrip -->
      <%- include('../../ejs/loadingbar.ejs') %>

        <!-- Modal Header -->
        <div class="modal-header">
          <h5 class="modal-title" id="lblModalTripAdd">출장 업로드</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          <form class="needs-validation" novalidate>
            <button type="submit" id="btnImportTrip" class="visually-hidden" onclick="importTrip(this, event)"></button>
            <div class="input-group mb-3">
              <span class="input-group-text"><i class="fa fa-file"></i></span>
              <div class="has-validation">
                <input type="file" id="file" class="form-control" required accept=".xlsx">
              </div>
              <div class="invalid-feedback">
                파일을 업로드하세요.
              </div>                
            </div>            
          </form>
        </div>

        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-primary"
          onclick="document.getElementById('btnImportTrip').click();">파일 올리기</button>
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">닫기</button>
        </div>

    </div>
  </div>
</div>

<%# 출장 개별 등록 %>

<%# 출장 개별 수정 %>

<script>
  var table = {};

  $(document).ready( function () {

    //DataTable.js
    table = DataTableJS('tblMain', '/business/trip/getTripList');  

    //CheckBox Visible
    table.column(0).visible(false);

    //Click Event
    $('#tblMain tbody').on('click', 'tr td:not(:first-child)', function(e) {
      var isOn = table.column(0).visible();

      //편집 모드
      if(isOn){
        alert('개발중입니다.');
      }
      //읽기 모드
      else{
        const rowData = table.row(this).data();
        let tripGuid = rowData.TRIP_MST_GUID;
        let expiredDate = rowData.EXPIRE_DT;
        let nowDate = dateFormat(new Date(), false);

        if(nowDate <= expiredDate){
          var param = 'tripGuid=' + tripGuid;
          location.href = '/business/trip/detail?' + param;
        }
        else{
          $("#modalAlert .modal-title").html("만료된 출장");          
          $("#modalAlert .modal-body").html('모바일 앱에서 더보기 -> 광고보기를 하여 7일의 기간을 갱신할 수 있습니다.');
          $("#modalAlert").modal('show');
        }
      }
    });          
  });

  const columns = [
    {title: '', name: 'CHK', data : 'CHK', width: "50px"},
    {title: 'No.', name: 'NO', data : "NO", width: "50px" },
    {title: '이름', name: 'TTL', data : "TTL", width: "auto"},
    {title: '만료일', name: 'EXPIRE_DT', data : "EXPIRE_DT", width: "200px"},
    {title: '등록자', name: 'REG_EMAIL', data : "REG_EMAIL", width: "200px"},
    {title: '등록일시', name: 'REG_DT', data : "REG_DT", width: "200px" },
  ];

  const columnDefs = [
    { className: "header", targets: "_all" },
    { 
      orderable: false,
      render: DataTable.render.select(),
      targets: 0,
      visible: false,
    },        
    { className: "row-left-align", targets: 'TTL:name' },
    { className: "row-center-align", targets: ['EXPIRE_DT:name', 'REG_EMAIL:name', 'REG_DT:name'] },
    { className: "row-right-align", targets: ['No.:name'] },
  ];

  function DataTableJS(tblId, url){
    var table = new DataTable('#' + tblId, {
      columns: columns,
      columnDefs: columnDefs, 
      language : getLanguage(),
      paging: true,
      lengthChange: true,
      searching: false,
      ordering: true,
      info: true,            
      destroy: true,
      fixedColumns: {
        start: 2
      },
      order: [['NO', 'asc']],    
      select: {
        style: 'multi',
        selector: 'td:first-child',
      },
      ajax: {
          url: url,
          dataSrc: 'value' ,
          method: 'post',
      },
    });

    return table;
  };

  //신규 등록
  function createItem(){
    $("#modalTripAdd").modal('show');
  };

  //일괄 등록
  function importTrip(eThis, e) {
    //HTML5 기본 Validation
    if (!document.getElementById("file").validity.valid) {
      return false;
    }

    var fileVal = $("#file").val();
    if(fileVal != "" ){
        var ext = fileVal.split('.').pop().toLowerCase(); //확장자분리
        //아래 확장자가 있는지 체크
        if($.inArray(ext, ['xlsx']) == -1) {
          $("#modalImportTrip").modal('hide');
          $("#modalAlert .modal-title").html("출장 업로드");
          $("#modalAlert .modal-body").html('xlsx 파일만 업로드 할수 있습니다.');
          $("#modalAlert").modal('show');
          e.preventDefault(); //HTML5 기본 validation 밑에 위치 필수
          return false;
        }
    }    

    e.preventDefault(); //HTML5 기본 validation 밑에 위치 필수

    var formData = new FormData();
    var files = $("#modalImportTrip").find("form input[type=file]")[0].files;
    formData.append('file', files[0]);

    $.ajax({
      url: '/business/trip/importTripForWeb',
      method: 'POST',
      data: formData,
      cache: false,
      contentType: false,
      processData: false,
      beforeSend: function (xhr) {
        setLoadingBar(true, 'modalImportTrip');
        $("#modalAlert .modal-title").html("출장 업로드");
      },
      success: function (data, status, xhr) {
        // var message = data.message;
        // $("#modalAlert .modal-body").html(message);
        location.reload(true);
      },
      error: function (data, status, err) {
        $("#modalAlert .modal-body").html(err);
      },
      complete: function () {
        setLoadingBar(false, 'modalImportTrip');
        $("#modalImportTrip").modal('hide');
        $("#modalAlert").modal('show');
      }
    });
    };

  //리스트 삭제
  function deleteItemList(e){
    const rows = table.rows('.selected').data();
    var tripGuidList = getValueList(rows, 'TRIP_MST_GUID');
    var data = {
      'tripGuidList': tripGuidList,
    };

    confirmModal(e, 'modalConfirm', '모두의 출장', '선택한 출장을 삭제 하시겠습니까?', function () {   
      $.ajax({
        url: '/business/trip/deleteTripList',
        method: 'POST',
        data: JSON.stringify(data),
        datatype: "JSON",
        contentType: 'application/json; charset=utf-8',
        beforeSend: function (xhr) {
          setLoadingBar(true);
          $("#modalConfirm").modal('hide');
          $("#modalAlert .modal-title").html("공지사항");
        },
        success: function (data, status, xhr) {
          // var message = data.message;
          // $("#modalAlert .modal-body").html(message);
          // $("#modalAlert").modal('show');
          location.href = '/business/trip/';
        },
        error: function (data, status, err) {
          $("#modalAlert .modal-body").html(err);
          $("#modalAlert").modal('show');
        },
        complete: function () {
          setLoadingBar(false);
        }
      });    
    });
  };

  //편집모드
  function editItem(eThis){
    var isOn = !(table.column(0).visible());

    //Active 클래스 추가
    if(isOn){
      //편집,보기 버튼
      $(eThis).addClass('active');
      $(eThis).removeClass('btn-warning');
      $(eThis).addClass('btn-success');
      $(eThis).text('보기');

      //체크박스
      table.column(0).visible(true);

      //삭제
      $("#btnCreate").closest('div').addClass('visually-hidden');
      $("#btnDelete").closest('div').removeClass('visually-hidden');
    }
    else{
      //편집,보기
      $(eThis).removeClass('active');
      $(eThis).removeClass('btn-success');
      $(eThis).addClass('btn-warning');
      $(eThis).text('편집');
      $("#chkVisible").val('N');

      //체크박스
      table.column(0).visible(false);

      //등록,삭제
      $("#btnCreate").closest('div').removeClass('visually-hidden');
      $("#btnDelete").closest('div').addClass('visually-hidden');
    }
  };

</script>