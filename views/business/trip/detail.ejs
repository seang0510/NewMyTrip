<%# 공통 부분 %>
<%- include('../../layout/common.ejs') %>

<%# CSS & JS %>
<link href="/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
<link href="/css/select.dataTables.min.css" rel="stylesheet" />
<link href="/css/responsive.dataTables.min.css" rel="stylesheet" />
<link href="/css/fixedColumns.dataTables.min.css" rel="stylesheet" />
<link href="/css/fixedHeader.dataTables.min.css" rel="stylesheet" />
<link href="/stylesheets/datatable.css" rel="stylesheet" />

<%# JS %>
<script src="/js/dataTables.min.js"></script>
<script src="/js/dataTables.bootstrap5.min.js"></script>
<script src="/js/dataTables.select.js"></script>
<script src="/js/select.dataTables.js"></script>
<script src="/js/dataTables.responsive.js"></script>
<script src="/js/responsive.dataTables.js"></script>
<script src="/js/dataTables.fixedColumns.js"></script>
<script src="/js/fixedColumns.dataTables.js"></script>
<script src="/js/dataTables.fixedHeader.js"></script>
<script src="/js/fixedHeader.dataTables.js"></script>
<script src="/javascripts/datatableOption.js"></script>

<%# 본문 %>
<%- contentFor('body') %>

<%# DataTable CheckBox Visible %>
<input type="hidden" id="tripGuid" value='<%= tripGuid %>'>

<%# 메뉴명 & 버튼 %>
<div class="d-flex">
  <div class="ps-1">
    <h2>모두의 출장 상세</h2>
  </div>
  <div class="d-flex ms-auto">
    <div>
      <button type="button" id="btnCreate" class="btn btn-primary" onclick="createItem()">등록</button>      
    </div>
    <div class="ms-1 visually-hidden">
      <button type="button" id="btnDelete" class="btn btn-danger" onclick="deleteItemList(event)">삭제</button>
    </div>
    <div class="ms-1">
      <button type="button" class="btn btn-warning" onclick="editItem(this)">편집</button>      
    </div>    
    <div class="ms-1">
      <button type="button" class="btn btn-secondary" onclick="closeItem()">닫기</button>
  </div>      
  </div>
</div>

<%# 그리드 %>
<table id="tblMain" class="table table-striped">
</table>

<script>
  var table = {};

  $(document).ready( function () {
    //DataTable.js
    InitDataTableJS('tblMain', '/business/trip/getTripDetailList');  

    //Click Event
    $('#tblMain tbody').on('click', 'tr td:not(.dt-select):not(.dtr-control)', function(e) {      debugger;
      var isOn = table.column('CHK:name').visible();

      //편집 모드
      if(isOn){
        $("#modalAlert .modal-title").html("오류");
        $("#modalAlert .modal-body").html('개발중입니다.');
        $("#modalAlert").modal('show');
      }
      //읽기 모드
      else{
        $("#modalAlert .modal-title").html("오류");
        $("#modalAlert .modal-body").html('개발중입니다.');
        $("#modalAlert").modal('show');
      }
    });          
  });

  const columnDefs = [
    { targets: "_all", className: "header" },
    { targets: 0, orderable: false, searchable: false, className: 'control', render: false, },
    { targets: 1, orderable: false, render: DataTable.render.select() },    
  ];

  function InitDataTableJS(tblId, url){
    var columns = [];
    var columnNames = [];
    var gridDate = [];
    var select = {};

    $.ajax({
        url: url,
        method: 'post',
        data: {
          'tripGuid': $("#tripGuid").val()
        },
        success: function(data){
          if(isEmpty(data) || (isEmpty(data.value) && isEmpty(data.columnNames))){
            gridData = null;

            //줄여보기 및 체크박스
            columns.push({title: '', data : null, defaultContent: '', width: "0px", visible: false });
            columns.push({title: '', data : null, width: "50px", visible: true });  
            
            columns.push(getDataInfoFromColName('ODR'));
            columns.push(getDataInfoFromColName('FCLT_NM'));
            columns.push(getDataInfoFromColName('ADDR'));
            columns.push(getDataInfoFromColName('ADDR_DTL'));
            columns.push(getDataInfoFromColName('LAT'));
            columns.push(getDataInfoFromColName('IMG_CNT'));
            columns.push(getDataInfoFromColName('REG_EMAIL'));
            columns.push(getDataInfoFromColName('REG_DT'));
          }
          else{
            if(isEmpty(data.value)){
              gridData = null;
              columnNames = Object.values(data.columnNames);
            }
            else{
              gridData = data.value;
              columnNames = Object.keys(gridData[0]);         
            }

            //줄여보기 및 체크박스
            columns.push({title: '', data : null, defaultContent: '', width: "0px", visible: false });
            columns.push({title: '', data : null, width: "50px", visible: false });

            for(var col = 0; col < columnNames.length; col++) {
              var data = getDataInfoFromColName(columnNames[col]);
              columns.push(data);
            }

            columnDefs.push({ targets: ['NO:name','IMG_CNT:name'], className: "row-right-align" });
            columnDefs.push({ targets: 'TTL:name', className: "row-left-align" });
            columnDefs.push({ targets: ['REG_EMAIL:name','REG_DT:name'] , className: "row-center-align" });
          }
        },
        beforeSend: function (xhr) {
          setLoadingBar(true);
        },
        complete: function () {
          setLoadingBar(false);

          table = new DataTable('#' + tblId, {
            data: gridData,
            columns: columns,
            columnDefs: columnDefs,             
            language : getLanguage(),
            paging: true,
            lengthChange: true,
            searching: false,
            ordering: true,
            info: true,            
            scrollCollapse: true,
            select: {
              style: 'multi',
              selector: 'td.dt-select',
              items: 'row',
            },                     
            scrollX: true,
            scrollY: true,
            // responsive: true,            
            fixedColumns: {
              start: 4
            },        
            order: [[2, 'asc']],                                
          });          
        }   
    });
  };

  function getDataInfoFromColName(colName){
    let info = {};
    switch(colName){
      case 'ODR':
        info = {
          title: 'No.',
          name: colName,
          data: colName,
          width: '50px',
        };
        break;
      case 'FCLT_NM':
        info = {
          title: '명칭',
          name: colName,
          data: colName,          
          width: '100px',
        };
        break;        
      case 'ADDR':
        info = {
          title: '주소',
          name: colName,
          data: colName,
          width: '300px',
        };
        break;      
      case 'ADDR_DTL':
        info = {
          title: '상세 주소',
          name: colName,
          data: colName,
          width: '200px',
        };
        break;                
      case 'LAT':
        info = {
          title: '위도',
          name: colName,
          data: colName,
          width: '100px',
        };
        break;            
      case 'LNG':
        info = {
          title: '경도',
          name: colName,
          data: colName,
          width: '100px',
        };
        break;      
      case 'IMG_CNT':
        info = {
          title: '사진',
          name: colName,
          data: colName,
          width: '100px',
        };
        break;             
      case 'REG_EMAIL':
        info = {
          title: '등록자',
          name: colName,
          data: colName,
          width: '100px',
        };
        break;      
      case 'REG_DT':
        info = {
          title: '등록일시',
          name: colName,
          data: colName,
          width: '100px',
        };
        break;                         
      case 'TRIP_MST_GUID':
      case 'TRIP_DTL_GUID':
      case 'TRIP_DTL_GUID_IN_ITM':
      case 'COMP_YN':
      case 'UPDT_EMAIL':
      case 'UPDT_DT':
        info = {
          title: colName,
          name: colName,
          data: colName,          
          width: '0px',
          visible: false,
        };        
        break;
      default:        
        info = {
          title: colName,
          name: colName,
          data: colName,          
          width: '100px',
        };
        break;
    }
    return info;
  };

  //신규 등록
  function createItem(){
    $("#modalAlert .modal-title").html("오류");
    $("#modalAlert .modal-body").html('개발중입니다.');
    $("#modalAlert").modal('show');
  };

  //리스트 삭제
  function deleteItemList(e){
    $("#modalAlert .modal-title").html("오류");
    $("#modalAlert .modal-body").html('개발중입니다.');
    $("#modalAlert").modal('show');
  };

  //편집모드
  function editItem(eThis){
    var isOn = !(table.column(1).visible());

    //Active 클래스 추가
    if(isOn){
      //편집,보기 버튼
      $(eThis).addClass('active');
      $(eThis).removeClass('btn-warning');
      $(eThis).addClass('btn-success');
      $(eThis).text('보기');

      //체크박스
      table.column(1).visible(true);

      //삭제
      $("#btnCreate").closest('div').addClass('visually-hidden');
      $("#btnDelete").closest('div').removeClass('visually-hidden');
    }
    else{
      //편집,보기
      $(eThis).removeClass('active');
      $(eThis).removeClass('btn-success');
      $(eThis).addClass('btn-warning');
      $(eThis).text('편집');

      //체크박스
      table.column(1).visible(false);

      //등록,삭제
      $("#btnCreate").closest('div').removeClass('visually-hidden');
      $("#btnDelete").closest('div').addClass('visually-hidden');
    }
  };

  //닫기
  function closeItem(){
    history.back();
  };

</script>